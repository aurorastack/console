<template>
    <div class="cloud-service-history-changes-tab">
        <p-panel-top :title="$t('INVENTORY.CLOUD_SERVICE.HISTORY.DETAIL.CHANGES')" use-total-count :total-count="changesCount" />
        <div class="cloud-service-history-changes-wrapper">
            <nav class="cloud-service-history-changes-key-nav">
                <p-card :header="$t('INVENTORY.CLOUD_SERVICE.HISTORY.DETAIL.CHANGES_TAB.CHANGED_KEYS')">
                    <p-context-menu :menu="keyMenus" :selected="[{name: selectedKeyMenu}]" @select="handleSelect">
                        <template #item--format="{ item }">
                            <div class="flex justify-between items-center">
                                <span>{{ item.label }}</span>
                                <p-i v-if="item.updateType === 'ADDED'" name="ic_plus" color="#60B731"
                                     width="1rem" height="1rem" class="p-i-ic_plus"
                                />
                            </div>
                        </template>
                    </p-context-menu>
                </p-card>
            </nav>
            <nav class="cloud-service-history-changes-code-nav">
                <p-card>
                    <template #header>
                        <div class="cloud-service-history-changes-code-header-wrapper">
                            <div>
                                <span>data</span>
                                <p-i v-if="selectedKeyMenu" name="ic_arrow_right" color="#898995"
                                     scale="0.7"
                                />
                                <span>{{ selectedKeyMenu }}</span>
                            </div>
                            <p-i width="1rem" height="1rem" :name="folding ? 'ic_code-expand' : 'ic_code-collapse'"
                                 class="cursor-pointer" @click="handleCodeDisplayType"
                            />
                        </div>
                    </template>
                    <div class="secondary-header">
                        <div>{{ $t('INVENTORY.CLOUD_SERVICE.HISTORY.DETAIL.CHANGES_TAB.PREVIOUS') }}</div>
                        <div>{{ $t('INVENTORY.CLOUD_SERVICE.HISTORY.DETAIL.CHANGES_TAB.CHANGED') }}</div>
                    </div>
                    <div class="cloud-service-history-changes-code-area">
                        <vue-diff :prev="previousValue" :current="changedValue" :folding="folding" />
                    </div>
                </p-card>
            </nav>
        </div>
    </div>
</template>

<script lang="ts">
import type { PropType } from '@vue/composition-api';
import {
    computed, defineComponent, reactive, toRefs,
} from '@vue/composition-api';

import {
    PPanelTop, PCard, PContextMenu, PI,
} from '@spaceone/design-system';

import vueDiff from '@/common/components/forms/vue-diff/Diff.vue';

import type {
    CloudServiceHistoryItem,
} from '@/services/asset-inventory/cloud-service/cloud-service-detail/type';

export default defineComponent({
    name: 'CloudServiceHistoryChangesTab',
    components: {
        vueDiff,
        PPanelTop,
        PCard,
        PContextMenu,
        PI,
    },
    props: {
        selectedHistoryItem: {
            type: Object as PropType<CloudServiceHistoryItem>,
            default: () => ({}),
        },
        selectedKeyName: {
            type: String,
            default: '',
        },
    },
    setup(props) {
        const state = reactive({
            keyMenus: computed(() => props.selectedHistoryItem?.diffItems?.map(d => ({ label: d.key, name: d.key, updateType: d.type })) ?? []),
            selectedKeyMenu: props.selectedKeyName || props.selectedHistoryItem?.diffItems?.at(0)?.key || '',
            changesCount: computed(() => props.selectedHistoryItem?.diffCount ?? 0),
            filteredDiffItem: computed(() => props.selectedHistoryItem?.diffItems?.filter(d => d.key === state.selectedKeyMenu) ?? []),
            previousValue: computed(() => valueConverter(state.filteredDiffItem[0]?.previousValue)),
            changedValue: computed(() => valueConverter(state.filteredDiffItem[0]?.changedValue)),
            folding: false,
        });

        const valueConverter = (value) => {
            if (typeof value === 'string' && value.length) {
                if (value.startsWith('{') || value.startsWith('[')) {
                    try {
                        return JSON.stringify(JSON.parse(value), undefined, 2);
                    } catch {
                        return undefined;
                    }
                }
                return value;
            }
            return undefined;
        };

        const handleSelect = (menu) => { state.selectedKeyMenu = menu.label; };

        const handleCodeDisplayType = () => { state.folding = !state.folding; };

        return {
            ...toRefs(state),
            handleCodeDisplayType,
            handleSelect,
        };
    },
});
</script>

<style lang="postcss" scoped>
.cloud-service-history-changes-tab {
    height: 100%;
    padding: 1rem;
    .p-panel-top {
        margin: 0.5rem 0 1rem 0;
    }
    .cloud-service-history-changes-wrapper {
        @apply flex;
        height: calc(100% - 3.5rem);
        .cloud-service-history-changes-key-nav {
            width: 20%;
            .p-card::v-deep {
                height: 100%;

                header {
                    @apply border-gray-200 border-solid border border-b;
                    height: 2.25rem;
                    border-top-right-radius: 0;
                }
                .body {
                    height: calc(100% - 2.25rem);
                    border-bottom-right-radius: 0;
                }
                .p-context-menu {
                    border: none;
                }
            }
            .p-i-ic_plus {
                @apply border-green-600 border border-solid;
                border-radius: 0.25rem;
            }
        }
        .cloud-service-history-changes-code-nav {
            width: 80%;
            .p-card::v-deep {
                height: 100%;
                header {
                    @apply flex items-center border border-b border-solid;
                    height: 2.25rem;
                    border-top-left-radius: 0;
                    border-left: 0;
                }
                .secondary-header {
                    @apply flex;
                    height: 1.625rem;
                    & > :last-child {
                        @apply border-solid border-l;
                    }
                    div {
                        @apply bg-gray-100 text-sm text-gray-500 w-1/2 border-gray-200 border-b border-solid;
                        padding: 0.25rem 0.75rem;
                    }
                }
                .body {
                    border-bottom-left-radius: 0;
                    border-left: 0;
                    height: calc(100% - 2.25rem);
                    padding: 0;
                }
                .cloud-service-history-changes-code-area {
                    height: calc(100% - 1.5rem);
                }
                .cloud-service-history-changes-code-header-wrapper {
                    @apply flex justify-between w-full align-middle text-sm;
                }
            }
        }
    }
}

@screen tablet {
    .cloud-service-history-changes-tab {
        height: 30rem;
    }
}

@screen mobile {
    .cloud-service-history-changes-tab {
        height: 56rem;
        .cloud-service-history-changes-wrapper {
            flex-flow: column;
            & nav {
                width: 100% !important;
            }
            .cloud-service-history-changes-key-nav {
                .p-card::v-deep {
                    .body {
                        max-height: 11.25rem;
                        overflow-y: scroll;
                        border-radius: 0;
                    }
                }
            }
            .cloud-service-history-changes-code-nav {
                height: 3.5rem;
                .p-card::v-deep {
                    @apply border-l border-gray-200;
                    header {
                        height: 100%;
                        border-radius: 0;
                        border-top: none;
                    }
                    .body {
                        height: 40rem;
                    }
                    .cloud-service-history-changes-code-header-wrapper {
                        @apply w-full align-middle flex-col gap-1;
                        & div {
                            display: inline-flex !important;
                            &:last-child {
                                @apply justify-end;
                            }
                        }
                    }
                }
            }
        }
    }
}
</style>
